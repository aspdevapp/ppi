<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPI - Portal de Processos Interno</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-color: #0056b3;
            --secondary-color: #f4f4f4;
            --border-color: #ddd;
            --text-color: #333;
            --success-color: #28a745;
            --dark-color: #343a40;
            --danger-color: #dc3545;
            --disabled-bg: #e9ecef;
            --email-color: #6f42c1;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #e9ecef; margin: 0; padding: 20px; color: var(--text-color); }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); position: relative; }
        
        .top-buttons { position: absolute; top: 20px; right: 20px; display: flex; gap: 10px; }
        .btn-reset { background-color: var(--success-color); color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: bold; transition: background 0.3s; }
        .btn-reset:hover { background-color: #218838; }
        .btn-config { background-color: var(--dark-color); color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 16px; transition: background 0.3s; }
        .btn-config:hover { background-color: #23272b; }

        header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; padding-top: 20px; }
        h1 { color: var(--primary-color); margin: 0; }
        h2, h3 { color: #444; margin-top: 20px; }
        h4 { margin: 0 0 10px 0; color: var(--primary-color); }

        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; }
        input[type="text"], input[type="number"], input[type="date"], select, textarea { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; box-sizing: border-box; }
        input[type="file"] { background-color: white; padding: 10px; }
        select:disabled, input:disabled { background-color: var(--disabled-bg); color: #6c757d; cursor: not-allowed; }

        .section-content { display: none; padding: 20px; border: 1px solid var(--border-color); border-radius: 4px; background-color: #fafafa; margin-top: 15px; animation: fadeIn 0.5s; }
        .alcada-container { display: none; margin-top: 20px; background: #fff; padding: 15px; border: 1px solid #ccc; }
        
        .alcada-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .alcada-table th, .alcada-table td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        .alcada-table th { background-color: var(--primary-color); color: white; }

        .sub-form-alert { display: none; background-color: #fff3cd; border: 1px solid #ffeeba; padding: 15px; margin-top: 10px; border-radius: 4px; }
        
        .restricao-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; background-color: white; }
        .restricao-table th, .restricao-table td { border: 1px solid #e0c482; padding: 8px; text-align: left; }
        .restricao-table th { background-color: #ffecb5; color: #856404; }

        .btn-add-row { background-color: var(--success-color); color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .btn-remove-row { background-color: var(--danger-color); color: white; border: none; padding: 2px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-left: 5px; }

        .flex-cell { display: flex; align-items: center; }
        .defesa-container { margin-top: 15px; border-top: 1px solid #e0c482; padding-top: 15px; }
        .row-dates { display: flex; gap: 15px; margin-bottom: 10px; }
        .col-date { flex: 1; }

        button.btn-generate { background-color: var(--primary-color); color: white; padding: 15px 30px; border: none; border-radius: 4px; cursor: pointer; font-size: 18px; font-weight: bold; width: 100%; margin-top: 20px; display: flex; justify-content: center; align-items: center; gap: 10px; }
        button.btn-generate:hover { background-color: #004494; }

        #resultadoModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; overflow-y: auto; padding: 20px; }
        .resultado-content { background: #fff; max-width: 800px; margin: 0 auto; padding: 20px; border-radius: 8px; text-align: center; }
        
        .action-buttons { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin-top: 15px; }
        .btn-copy { background-color: #17a2b8; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; display: flex; align-items: center; gap: 5px;}
        .btn-download { background-color: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; display: flex; align-items: center; gap: 5px;}
        .btn-email { background-color: var(--email-color); color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; display: flex; align-items: center; gap: 5px;}
        .btn-email:hover { background-color: #5a32a3; }
        .btn-close-res { background-color: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }

        /* RELAT√ìRIO OCULTO */
        #reportToImage { position: absolute; left: -9999px; top: 0; width: 800px; background: white; padding: 40px; font-family: Arial, sans-serif; border: 1px solid #ccc; box-sizing: border-box; }
        #reportToImage h2 { border-bottom: 2px solid #0056b3; color: #0056b3; padding-bottom: 10px; text-transform: uppercase; }
        .rep-row { margin-bottom: 10px; display: flex; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .rep-label { font-weight: bold; width: 250px; color: #555; }
        .rep-value { flex: 1; color: #000; font-weight: 500; }
        
        .rep-table { width: 100%; border-collapse: collapse; margin-top: 15px; margin-bottom: 15px; font-size: 14px; }
        .rep-table th, .rep-table td { border: 1px solid #999; padding: 6px; text-align: left; }
        .rep-table th { background-color: #0056b3; color: white; }

        .rep-images img { max-width: 100%; margin-top: 10px; border: 1px solid #ccc; padding: 5px; display: block; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 8px; width: 500px; max-width: 90%; }
        .modal-footer { display: flex; justify-content: space-between; margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px; }
        textarea.config-area { width: 100%; height: 120px; font-family: monospace; font-size: 12px; margin-bottom: 15px; resize: vertical; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    <div class="top-buttons">
        <button class="btn-config" onclick="abrirConfig()" title="Configura√ß√µes">‚öôÔ∏è</button>
        <button class="btn-reset" onclick="novaSolicitacao()" title="Limpar formul√°rio">‚Üª NOVA SOLICITA√á√ÉO</button>
    </div>

    <header>
        <h1>PPI - Portal de Processos Interno</h1>
        <p>Centraliza√ß√£o de Vendas, P√≥s-Vendas e Administrativo</p>
    </header>

    <div class="form-group">
        <label for="tipoSolicitacao">Tipo de Solicita√ß√£o:</label>
        <select id="tipoSolicitacao" onchange="mudarSecaoPrincipal()">
            <option value="">-- Selecione --</option>
            <option value="VENDAS">VENDAS</option>
            <option value="POS_VENDAS">P√ìS VENDAS</option>
            <option value="ADMINISTRATIVO">ADMINISTRATIVO</option>
        </select>
    </div>

    <div id="section-VENDAS" class="section-content">
        <h2>Solicita√ß√£o de Vendas</h2>
        <div class="form-group"><label>Sub-tipo de Venda:</label><select id="subTipoVenda"><option value="CAPI">CAPI DE VENDAS</option><option value="POC">POC DE VENDAS</option></select></div>
        <h3>Dados do Cliente</h3>
        <div class="form-group"><label>Raz√£o Social:</label><input type="text" id="inpRazao" placeholder="Digite a Raz√£o Social" oninput="this.value = this.value.toUpperCase()"></div>
        <div class="form-group"><label>Nome do Lead (Sparta):</label><input type="text" id="inpLead" placeholder="Nome igual do SPARTA" oninput="this.value = this.value.toUpperCase()"></div>
        
        <div class="form-group">
            <label>Em que Estado o cliente fica localizado?</label>
            <select id="inpEstado">
                <option value="">Selecione...</option>
                <option value="AC">AC</option><option value="AL">AL</option><option value="AP">AP</option><option value="AM">AM</option>
                <option value="BA">BA</option><option value="CE">CE</option><option value="DF">DF</option><option value="ES">ES</option>
                <option value="GO">GO</option><option value="MA">MA</option><option value="MT">MT</option><option value="MS">MS</option>
                <option value="MG">MG</option><option value="PA">PA</option><option value="PB">PB</option><option value="PR">PR</option>
                <option value="PE">PE</option><option value="PI">PI</option><option value="RJ">RJ</option><option value="RN">RN</option>
                <option value="RS">RS</option><option value="RO">RO</option><option value="RR">RR</option><option value="SC">SC</option>
                <option value="SP">SP</option><option value="SE">SE</option><option value="TO">TO</option>
            </select>
        </div>

        <div class="form-group"><label>Quantidade de Lojas:</label><input type="number" id="inpLojas" placeholder="0"></div>
        <div class="form-group"><label>Segmento:</label><select id="inputSegmento" onchange="verificarFaturamento()"><option value="">Carregando...</option></select></div>
        <div class="form-group"><label>Produto:</label><select id="inpProduto" onchange="verificarFaturamento()"><option value="MultiCheck">MultiCheck</option><option value="MultiCredi√°rio">MultiCredi√°rio</option><option value="PayCheck">PayCheck</option></select></div>
        <hr>
        <div class="form-group"><label>H√° condi√ß√£o fora da al√ßada do regional?</label><select id="selectForaAlcada" onchange="toggleAlcada()"><option value="NAO">N√ÉO</option><option value="SIM">SIM</option></select></div>

        <div id="boxAlcada" class="alcada-container">
            <h3>Tabela de Condi√ß√µes Especiais</h3>
            <table class="alcada-table" id="tabelaCondicoesBase">
                <thead><tr><th style="width: 40%;">ITEM</th><th style="width: 30%;">VALOR / DADO</th><th style="width: 30%;">AL√áADA</th></tr></thead>
                <tbody>
                    <tr><td>Faturamento Presumido</td><td><input type="text" id="inputFaturamento" placeholder="0,00" onkeyup="formatarMoedaInput(this); verificarFaturamento()"></td><td><select class="sel-alcada" id="selAlcadaFaturamento"></select></td></tr>
                    <tr><td>Data de Abertura CNPJ</td><td><input type="date" id="inputDataAbertura" onchange="verificarDataCNPJ()"></td><td><select class="sel-alcada" id="selAlcadaData"></select></td></tr>
                    <tr><td>Pend√™ncias Financeiras (R$)</td><td><input type="text" id="inputPendencias" placeholder="0,00" onkeyup="formatarMoedaInput(this); verificarPendencias()"></td><td><select class="sel-alcada" id="selAlcadaPendencias"></select></td></tr>
                </tbody>
            </table>
            
            <div id="formPendenciasDetalhe" class="sub-form-alert">
                <h4>Resumo das Restri√ß√µes (> R$ 7.500,01)</h4>
                <p style="font-size: 13px; color: #666; margin-top: -5px;">Liste abaixo todas as pend√™ncias que comp√µem o valor.</p>
                <table class="restricao-table" id="tabelaRestricoes">
                    <thead><tr><th style="width: 40%;">Fornecedor</th><th style="width: 30%;">Tipo de Restri√ß√£o</th><th style="width: 20%;">Valor (R$)</th><th style="width: 10%;">A√ß√£o</th></tr></thead>
                    <tbody></tbody>
                </table>
                <button type="button" class="btn-add-row" onclick="adicionarLinhaRestricao()">+ Adicionar Linha</button>
                <div class="defesa-container">
                    <h5 style="margin: 0 0 10px 0; color: #856404;">Defesa das Restri√ß√µes (Obrigat√≥rio > 100 caracteres)</h5>
                    <div class="row-dates"><div class="col-date"><label>Data da Primeira Restri√ß√£o:</label><input type="date" id="dataPrimeiraRestricao"></div><div class="col-date"><label>Data da √öltima Restri√ß√£o:</label><input type="date" id="dataUltimaRestricao"></div></div>
                    <div><label>Justificativa / Defesa:</label><textarea id="textoDefesaRestricao" rows="3" placeholder="Descreva aqui a defesa relacionada √†s restri√ß√µes informadas (M√≠nimo 100 caracteres)..."></textarea></div>
                </div>
            </div>

            <table class="alcada-table" style="margin-top:0; border-top:none;">
                <tbody id="tbodyAlcadaExtras">
                    <tr>
                        <td style="width: 40%;">Taxas (IP)</td>
                        <td style="width: 30%;"><input type="text" id="inputTaxaIP" value="0,00%" onkeyup="formatarPorcentagemInput(this); verificarTaxas()"></td>
                        <td style="width: 30%;"><select class="sel-alcada" id="selAlcadaTaxaIP" onchange="verificarTaxas()"></select></td>
                    </tr>
                    <tr>
                        <td>Taxas (Flat/A.M)</td>
                        <td><input type="text" id="inputTaxaFlat" value="0,00%" onkeyup="formatarPorcentagemInput(this); verificarTaxas()"></td>
                        <td><select class="sel-alcada" id="selAlcadaTaxaFlat" onchange="verificarTaxas()"></select></td>
                    </tr>
                    <tr><td>Prazo de Acatamento</td><td><input type="text" onkeyup="verificarGenerico(this)"></td><td><select class="sel-alcada"></select></td></tr>
                    <tr><td>TAP/TGO</td><td><input type="text" onkeyup="verificarGenerico(this)"></td><td><select class="sel-alcada"></select></td></tr>
                    <tr><td><input type="text" placeholder="Outro Item (Digite o nome)"></td><td><input type="text" onkeyup="verificarGenerico(this)"></td><td><select class="sel-alcada"></select></td></tr>
                </tbody>
            </table>
            
            <div id="formDefesaTaxas" class="sub-form-alert" style="display:none;">
                <h4 id="tituloDefesaTaxas" style="color: #856404; margin-top: 0;">Justificativa de Taxas</h4>
                <div>
                    <label>Defesa das taxas para Al√ßada (Obrigat√≥rio > 50 caracteres):</label>
                    <textarea id="textoDefesaTaxas" rows="3" placeholder="Justifique a solicita√ß√£o destas taxas especiais..."></textarea>
                </div>
            </div>

            <div style="text-align: right; margin-top: 10px;"><button type="button" class="btn-add-row" onclick="adicionarLinhaAlcada()">+ Adicionar Item Personalizado</button></div>
        </div>

        <div class="form-group" style="margin-top: 20px;"><label for="observacoesVendas">Parecer de Vendas (Obrigat√≥rio > 100 caracteres):</label><textarea id="observacoesVendas" rows="4" placeholder="Digite aqui o parecer de vendas (M√≠nimo 100 caracteres)..."></textarea></div>
        <div class="form-group" style="margin-top: 15px;"><label for="uploadSparta">PESQUISA PROFUNDA (SPARTA):</label><input type="file" id="uploadSparta" accept="image/*" multiple><p style="font-size: 12px; color: #666; margin-top: 5px;">Selecione as imagens ou prints da pesquisa (Permite m√∫ltiplos arquivos).</p></div>
        <button class="btn-generate" onclick="gerarImagemResumo()">üì∏ GERAR SOLICITA√á√ÉO DE VENDAS</button>
    </div>

    <div id="section-POS_VENDAS" class="section-content"><h2>P√≥s Vendas</h2><button class="btn-generate">Gerar Solicita√ß√£o</button></div>
    <div id="section-ADMINISTRATIVO" class="section-content"><h2>Administrativo</h2><button class="btn-generate">Gerar Solicita√ß√£o</button></div>
</div>

<div id="reportToImage"><h2 style="text-align:center;">SOLICITA√á√ÉO DE VENDAS - PPI</h2><div id="reportContent"></div><div id="reportImages" class="rep-images"></div></div>

<div id="resultadoModal">
    <div class="resultado-content">
        <h3 style="color: var(--primary-color);">Solicita√ß√£o Gerada com Sucesso!</h3>
        <p>Abaixo est√° a imagem gerada. Se "Copiar" falhar, use "Baixar" e anexe ao e-mail.</p>
        <div id="imgOutputContainer" style="border: 1px solid #ccc; padding: 5px; margin-bottom: 10px; overflow-x: auto;"></div>
        <div class="action-buttons">
            <button class="btn-email" onclick="prepararEmail()">üìß Criar E-mail</button>
            <button class="btn-copy" onclick="copiarImagem()">üìã Copiar Imagem</button>
            <button class="btn-download" onclick="baixarImagem()">üíæ Baixar Imagem</button>
            <button class="btn-close-res" onclick="document.getElementById('resultadoModal').style.display='none'">Fechar</button>
        </div>
    </div>
</div>

<div id="configModal" class="modal-overlay"><div class="modal-content"><div class="modal-header"><h3>Configura√ß√µes</h3><span style="cursor:pointer; font-size:20px;" onclick="fecharConfig()">√ó</span></div><label>Segmentos:</label><textarea id="cfgSegmentos" class="config-area"></textarea><label>Al√ßadas:</label><textarea id="cfgAlcadas" class="config-area"></textarea><div class="modal-footer"><button class="btn-reset-factory" onclick="resetarFabrica()">Restaurar Padr√µes</button><div><button onclick="fecharConfig()" style="margin-right:5px; padding:5px;">Cancelar</button><button onclick="salvarConfig()" style="padding:5px;">Salvar</button></div></div></div></div>

<script>
    const faturamentoRules = {"MultiCheck":{"AGRONEGOCIO":270000,"ALIMENTACAO":1000000,"AUTOMOTIVOS E NAUTICO":1000000,"CALCADOS E ACESSORIOS":135000,"COMBUSTIVEIS":1000000,"ELETRONICOS":1000000,"ENTRETENIMENTO":1000000,"INSTITUICOES DE ENSINO":345000,"JOALHERIA E BIJOUTERIAS":135000,"MAGAZINES E LOJAS DEPARTAMENTOS":220000,"MAQUINAS E PECAS":270000,"MATERIAL CONSTRUCAO E ACABAMENTO":1000000,"MOVEIS E DECORACAO":270000,"OTICA E RELOJOARIA":135000,"PRODUTOS DIVERSOS":1000000,"SAUDE E ESTETICA":900000,"SERVICOS DIVERSOS":220000,"TURISMO":1000000,"VESTUARIO":220000},"MultiCredi√°rio":{"AGRONEGOCIO":270000,"ALIMENTACAO":1000000,"AUTOMOTIVOS E NAUTICO":1000000,"CALCADOS E ACESSORIOS":220000,"COMBUSTIVEIS":1000000,"ELETRONICOS":570000,"ENTRETENIMENTO":1000000,"INSTITUICOES DE ENSINO":545000,"JOALHERIA E BIJOUTERIAS":185000,"MAGAZINES E LOJAS DEPARTAMENTOS":220000,"MAQUINAS E PECAS":270000,"MATERIAL CONSTRUCAO E ACABAMENTO":270000,"MOVEIS E DECORACAO":270000,"OTICA E RELOJOARIA":220000,"PRODUTOS DIVERSOS":1000000,"SAUDE E ESTETICA":220000,"SERVICOS DIVERSOS":220000,"TURISMO":1000000,"VESTUARIO":220000},"PayCheck":{"AGRONEGOCIO":270000,"ALIMENTACAO":1000000,"AUTOMOTIVOS E NAUTICO":1000000,"CALCADOS E ACESSORIOS":220000,"COMBUSTIVEIS":1000000,"ELETRONICOS":570000,"ENTRETENIMENTO":1000000,"INSTITUICOES DE ENSINO":545000,"JOALHERIA E BIJOUTERIAS":185000,"MAGAZINES E LOJAS DEPARTAMENTOS":220000,"MAQUINAS E PECAS":270000,"MATERIAL CONSTRUCAO E ACABAMENTO":270000,"MOVEIS E DECORACAO":270000,"OTICA E RELOJOARIA":220000,"PRODUTOS DIVERSOS":1000000,"SAUDE E ESTETICA":220000,"SERVICOS DIVERSOS":220000,"TURISMO":1000000,"VESTUARIO":220000}};

    function formatarMoedaInput(element) {
        let value = element.value.replace(/\D/g, "");
        value = (value / 100).toFixed(2) + "";
        value = value.replace(".", ",");
        value = value.replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
        element.value = value;
    }
    function formatarPorcentagemInput(element) {
        let value = element.value.replace(/\D/g, "");
        if (value === "") { element.value = ""; return; }
        value = (value / 100).toFixed(2) + "";
        value = value.replace(".", ",");
        element.value = value + "%";
    }
    function limparValorMoeda(valorStr) {
        if (!valorStr) return 0;
        let limpo = valorStr.replace("R$", "").replace("%","").trim();
        limpo = limpo.replace(/\./g, "").replace(",", ".");
        return parseFloat(limpo) || 0;
    }
    function formatarDataBR(dataStr) {
        if(!dataStr) return "-";
        const partes = dataStr.split('-');
        if(partes.length !== 3) return dataStr;
        return `${partes[2]}/${partes[1]}/${partes[0]}`;
    }
    function verificarGenerico(input) {
        const row = input.closest('tr');
        const select = row.querySelector('.sel-alcada');
        if(!select) return;
        const valStr = input.value.trim();
        const valNum = limparValorMoeda(valStr);
        // REFOR√áO DA REGRA VAZIO/ZERO/0,00%
        if (valStr === "" || valStr === "0,00" || valStr === "0,00%" || valNum === 0) { 
            select.value = "Aprovado"; 
            select.disabled = true; 
        } else { 
            select.disabled = false; 
        }
    }

    function verificarFaturamento() {
        const produto = document.getElementById('inpProduto').value;
        const segmento = document.getElementById('inputSegmento').value;
        const faturamentoStr = document.getElementById('inputFaturamento').value;
        const selAlcada = document.getElementById('selAlcadaFaturamento');
        const faturamentoVal = limparValorMoeda(faturamentoStr);

        if (!faturamentoStr || faturamentoStr.trim() === "" || faturamentoVal === 0) { selAlcada.value = "Aprovado"; selAlcada.disabled = true; return; }
        if (!produto || !segmento) { selAlcada.disabled = false; return; }

        let limite = 0;
        if (faturamentoRules[produto] && faturamentoRules[produto][segmento]) { limite = faturamentoRules[produto][segmento]; }

        if (limite > 0) {
            selAlcada.disabled = true;
            if (faturamentoVal < limite) { selAlcada.value = "CAPI"; } else { selAlcada.value = "Aprovado"; }
        } else {
            selAlcada.disabled = false;
        }
    }

    function verificarPendencias() {
        const inputValStr = document.getElementById('inputPendencias').value;
        const inputVal = limparValorMoeda(inputValStr);
        const detalheDiv = document.getElementById('formPendenciasDetalhe');
        const tbody = document.querySelector('#tabelaRestricoes tbody');
        const selAlcada = document.getElementById('selAlcadaPendencias');

        if (inputVal > 7500.01) { detalheDiv.style.display = 'block'; if(tbody.rows.length===0) adicionarLinhaRestricao(); } else { detalheDiv.style.display = 'none'; }

        if (!inputValStr || inputVal === 0) { selAlcada.value = "Aprovado"; selAlcada.disabled = true; return; }

        selAlcada.disabled = true; 
        if (inputVal <= 7500.00) { selAlcada.value = "Aprovado"; }
        else if (inputVal <= 35000.00) { selAlcada.value = "Ger√™ncia Nacional de Neg√≥cios"; }
        else if (inputVal <= 70000.00) { selAlcada.value = "Vice - Presid√™ncia"; }
        else { selAlcada.value = "Presid√™ncia"; }
    }

    function adicionarLinhaRestricao() {
        const tbody = document.querySelector('#tabelaRestricoes tbody');
        const row = document.createElement('tr');
        row.innerHTML = `<td><input type="text" placeholder="Fornecedor"></td><td><input type="text" placeholder="Tipo"></td><td><input type="text" placeholder="0,00" onkeyup="formatarMoedaInput(this)"></td><td style="text-align:center;"><button type="button" class="btn-remove-row" onclick="this.parentNode.parentNode.remove()">X</button></td>`;
        tbody.appendChild(row);
    }

    function verificarDataCNPJ() {
        const inputDateVal = document.getElementById('inputDataAbertura').value;
        const selectAlcada = document.getElementById('selAlcadaData');
        if (!inputDateVal) { selectAlcada.value = "Aprovado"; selectAlcada.disabled = true; return; }
        const dataAbertura = new Date(inputDateVal);
        const dataLimite = new Date(); dataLimite.setFullYear(dataLimite.getFullYear() - 1); dataAbertura.setHours(0,0,0,0); dataLimite.setHours(0,0,0,0);
        if (dataAbertura <= dataLimite) { selectAlcada.value = "Aprovado"; selectAlcada.disabled = true; } else { selectAlcada.value = "CAPI"; selectAlcada.disabled = true; }
    }

    function verificarTaxas() {
        const taxaIP = limparValorMoeda(document.getElementById('inputTaxaIP').value);
        const taxaFlat = limparValorMoeda(document.getElementById('inputTaxaFlat').value);
        const divDefesa = document.getElementById('formDefesaTaxas');
        const tituloDefesa = document.getElementById('tituloDefesaTaxas');
        
        verificarGenerico(document.getElementById('inputTaxaIP'));
        verificarGenerico(document.getElementById('inputTaxaFlat'));

        if (taxaIP > 0 || taxaFlat > 0) {
            divDefesa.style.display = 'block';
            const alcadaIP = document.getElementById('selAlcadaTaxaIP').value;
            const alcadaFlat = document.getElementById('selAlcadaTaxaFlat').value;
            let al√ßadasRelevantes = [];
            if(alcadaIP !== "Selecione..." && alcadaIP !== "Aprovado") al√ßadasRelevantes.push(alcadaIP);
            if(alcadaFlat !== "Selecione..." && alcadaFlat !== "Aprovado") al√ßadasRelevantes.push(alcadaFlat);
            al√ßadasRelevantes = [...new Set(al√ßadasRelevantes)];

            if(al√ßadasRelevantes.length > 0) {
                tituloDefesa.innerText = "Defesa das taxas para Al√ßada: " + al√ßadasRelevantes.join(" / ");
            } else {
                tituloDefesa.innerText = "Justificativa de Taxas (Al√ßada Definir)";
            }
        } else {
            divDefesa.style.display = 'none';
        }
    }

    function adicionarLinhaAlcada() {
        const tbody = document.getElementById('tbodyAlcadaExtras');
        const row = document.createElement('tr');
        const td1 = document.createElement('td'); td1.innerHTML = '<input type="text" placeholder="Item">';
        const td2 = document.createElement('td'); td2.innerHTML = '<input type="text" placeholder="Valor" onkeyup="verificarGenerico(this)">';
        const td3 = document.createElement('td'); td3.className = 'flex-cell';
        const select = document.createElement('select'); select.className = 'sel-alcada';
        select.value = "Aprovado"; select.disabled = true;
        currentAlcadas.forEach(alc => { let opt = document.createElement('option'); opt.value = alc; opt.text = alc; select.appendChild(opt); });
        const btnDel = document.createElement('button'); btnDel.type = 'button'; btnDel.textContent = 'X'; btnDel.className = 'btn-remove-row'; btnDel.onclick = function() { tbody.removeChild(row); };
        td3.appendChild(select); td3.appendChild(btnDel);
        row.appendChild(td1); row.appendChild(td2); row.appendChild(td3); tbody.appendChild(row);
    }

    // --- FUN√á√ÉO PREPARAR E-MAIL ---
    async function prepararEmail() {
        const razao = document.getElementById('inpRazao').value;
        const lead = document.getElementById('inpLead').value;
        const estado = document.getElementById('inpEstado').value;
        const subTipoSelect = document.getElementById('subTipoVenda');
        const subTipo = subTipoSelect.options[subTipoSelect.selectedIndex].text;
        
        const produtoFull = document.getElementById('inpProduto').value;
        let prodCode = "";
        if(produtoFull === "MultiCheck") prodCode = "CH";
        else if(produtoFull === "MultiCredi√°rio") prodCode = "CR";
        else if(produtoFull === "PayCheck") prodCode = "PAY";
        else prodCode = produtoFull;

        if(!razao || !lead || !estado || !document.getElementById('inputSegmento').value || !document.getElementById('inpLojas').value) {
            alert("Preencha todos os campos obrigat√≥rios e fa√ßa o Upload.");
            return;
        }
        
        const spartaInput = document.getElementById('uploadSparta');
        if (spartaInput.files.length === 0) {
            alert("ERRO: √â obrigat√≥rio fazer o upload de pelo menos 1 arquivo no campo PESQUISA PROFUNDA (SPARTA).");
            return;
        }

        await gerarImagemResumo(true); 
        
        const now = new Date();
        const hour = now.getHours();
        const saudacao = hour < 12 ? "Bom dia" : "Boa tarde";

        const subject = encodeURIComponent(`${subTipo} - ${prodCode} - ${razao} - ${lead} - ${estado}`);
        const rawBody = `${saudacao},

Segue processo de vendas do prospect ${lead}.

Em anexo as seguintes documenta√ß√µes:
- Fotos da Loja (interno e externo)
- Precifica√ß√£o
- Consulta (Crivo)

Abaixo Checklist da venda:

`; 
        const body = encodeURIComponent(rawBody);

        window.location.href = `mailto:?subject=${subject}&body=${body}`;
    }

    async function gerarImagemResumo(isEmailMode = false) {
        try {
            const razao = document.getElementById('inpRazao').value.trim();
            const lead = document.getElementById('inpLead').value.trim();
            const estado = document.getElementById('inpEstado').value;
            const lojas = document.getElementById('inpLojas').value.trim();
            const segmento = document.getElementById('inputSegmento').value;
            const produto = document.getElementById('inpProduto').value;

            // VALIDA√á√ÉO INCLUINDO ESTADO
            if (!razao || !lead || !estado || !lojas || !segmento || !produto) { 
                alert("ERRO: Preencha todos os campos obrigat√≥rios:\n- Raz√£o Social\n- Lead (Sparta)\n- Estado (UF)\n- Qtd. Lojas\n- Segmento\n- Produto"); 
                return; 
            }
            if (typeof html2canvas === 'undefined') { alert("Erro: Biblioteca de gera√ß√£o de imagem n√£o carregou. Verifique sua conex√£o."); return; }

            const spartaInput = document.getElementById('uploadSparta');
            if (spartaInput.files.length === 0) {
                alert("ERRO: √â obrigat√≥rio fazer o upload de pelo menos 1 arquivo no campo PESQUISA PROFUNDA (SPARTA).");
                return;
            }

            const pendenciasStr = document.getElementById('inputPendencias').value;
            const totalPendencias = limparValorMoeda(pendenciasStr);
            const parecer = document.getElementById('observacoesVendas').value || '';
            
            if(parecer.length < 100) { alert(`ERRO: Parecer de Vendas deve ter no m√≠nimo 100 caracteres.`); return; }

            if (totalPendencias > 7500.01) {
                let somaRestricoes = 0;
                let erroCamposTabela = false;
                document.querySelectorAll('#tabelaRestricoes tbody tr').forEach(row => {
                    const inputs = row.querySelectorAll('input');
                    const val = limparValorMoeda(inputs[2].value);
                    if (inputs[2].value !== "" && (inputs[0].value.trim() === "" || inputs[1].value.trim() === "")) erroCamposTabela = true;
                    somaRestricoes += val;
                });

                if (erroCamposTabela) { alert("Preencha Fornecedor e Tipo para as restri√ß√µes."); return; }
                if (Math.abs(totalPendencias - somaRestricoes) > 0.01) { alert("Soma das restri√ß√µes n√£o bate com o total."); return; }

                const txtDefesa = document.getElementById('textoDefesaRestricao').value.trim();
                if (!document.getElementById('dataPrimeiraRestricao').value || !document.getElementById('dataUltimaRestricao').value) { alert("Preencha as datas das restri√ß√µes."); return; }
                if (txtDefesa.length < 100) { alert("Defesa de restri√ß√µes deve ter no m√≠nimo 100 caracteres."); return; }
            }

            if(document.getElementById('formDefesaTaxas').style.display === 'block') {
                const txtTaxas = document.getElementById('textoDefesaTaxas').value.trim();
                if(txtTaxas.length < 50) { alert("ERRO: Defesa das Taxas deve ter no m√≠nimo 50 caracteres."); return; }
            }

            const reportDiv = document.getElementById('reportToImage');
            const contentDiv = document.getElementById('reportContent');
            const imgDiv = document.getElementById('reportImages');
            contentDiv.innerHTML = ''; imgDiv.innerHTML = '';

            const tipo = document.getElementById('tipoSolicitacao').value;
            let subTipo = "GERAL";
            if (tipo === 'VENDAS') {
                 const sb = document.getElementById('subTipoVenda');
                 subTipo = sb.options[sb.selectedIndex].text;
            }
            document.querySelector('#reportToImage h2').innerText = `SOLICITA√á√ÉO DE ${tipo} - ${subTipo}`;

            const foraAlcada = document.getElementById('selectForaAlcada').value;

            // ADICIONADO ESTADO NO HTML DA IMAGEM
            let html = `<div class="rep-row"><span class="rep-label">Tipo:</span> <span class="rep-value">VENDAS (${document.getElementById('subTipoVenda').value})</span></div>
                        <div class="rep-row"><span class="rep-label">Raz√£o:</span> <span class="rep-value">${razao}</span></div>
                        <div class="rep-row"><span class="rep-label">Lead:</span> <span class="rep-value">${lead}</span></div>
                        <div class="rep-row"><span class="rep-label">Estado:</span> <span class="rep-value">${estado}</span></div>
                        <div class="rep-row"><span class="rep-label">Lojas:</span> <span class="rep-value">${lojas}</span></div>
                        <div class="rep-row"><span class="rep-label">Seg:</span> <span class="rep-value">${segmento}</span></div>
                        <div class="rep-row"><span class="rep-label">Prod:</span> <span class="rep-value">${produto}</span></div>
                        <div class="rep-row"><span class="rep-label">Fora Al√ßada?</span> <span class="rep-value">${foraAlcada}</span></div>`;

            if(foraAlcada === 'SIM') {
                html += `<h3>Condi√ß√µes Especiais</h3><table class="rep-table"><thead><tr><th>Item</th><th>Valor</th><th>Al√ßada</th></tr></thead><tbody>`;
                document.querySelectorAll('#tabelaCondicoesBase tbody tr').forEach(tr => {
                    const tds = tr.querySelectorAll('td');
                    const item = tds[0].innerText.trim();
                    let val = tds[1].querySelector('input') ? tds[1].querySelector('input').value : '';
                    if(item.includes("Data")) val = formatarDataBR(val);
                    let alc = tds[2].querySelector('select') ? tds[2].querySelector('select').value : '';
                    if(alc !== "Aprovado") html += `<tr><td>${item}</td><td>${val}</td><td>${alc}</td></tr>`;
                });
                
                document.querySelectorAll('#tbodyAlcadaExtras tr').forEach(tr => {
                    const tds = tr.querySelectorAll('td');
                    let itemInput = tds[0].querySelector('input');
                    let item = itemInput ? itemInput.value : tds[0].innerText.trim();
                    let val = tds[1].querySelector('input').value;
                    let alc = tds[2].querySelector('select').value;
                    if(item && alc !== "Aprovado") html += `<tr><td>${item}</td><td>${val}</td><td>${alc}</td></tr>`;
                });
                html += `</tbody></table>`;

                if(totalPendencias > 7500.01) {
                    html += `<div style="border: 2px solid #dc3545; padding: 10px; margin-top: 15px; border-radius: 5px; background-color: #fff8f8;">
                                <h4 style="color: #dc3545; margin-top: 0; border-bottom: none;">‚ö†Ô∏è Detalhamento de Restri√ß√µes (> R$ 7.500,01)</h4>
                                <table class="rep-table" style="width: 100%; border: 1px solid #dc3545;">
                                    <thead><tr style="background-color: #dc3545; color: white;"><th>Fornecedor</th><th>Tipo de Restri√ß√£o</th><th>Valor (R$)</th></tr></thead>
                                    <tbody>`;
                    document.querySelectorAll('#tabelaRestricoes tbody tr').forEach(tr => {
                        const inputs = tr.querySelectorAll('input');
                        if(inputs[2].value) html += `<tr><td>${inputs[0].value}</td><td>${inputs[1].value}</td><td>R$ ${inputs[2].value}</td></tr>`;
                    });
                    html += `</tbody></table>`;
                    
                    const dt1 = formatarDataBR(document.getElementById('dataPrimeiraRestricao').value);
                    const dt2 = formatarDataBR(document.getElementById('dataUltimaRestricao').value);
                    const def = document.getElementById('textoDefesaRestricao').value;
                    html += `<div style="margin-top:10px; padding:10px; background:white; border:1px solid #f5c6cb;">
                                <strong style="color:#721c24;">DEFESA (1¬™: ${dt1} / √ölt: ${dt2}):</strong><br>
                                <div style="white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word; margin-top:5px; color:#333;">${def}</div>
                             </div></div>`;
                }

                if(document.getElementById('formDefesaTaxas').style.display === 'block') {
                    const tituloTaxas = document.getElementById('tituloDefesaTaxas').innerText;
                    const textoTaxas = document.getElementById('textoDefesaTaxas').value;
                    html += `<div style="border: 2px solid #dc3545; padding: 10px; margin-top: 15px; border-radius: 5px; background-color: #fff8f8;">
                                <h4 style="color: #dc3545; margin-top: 0; border-bottom: none;">‚ö†Ô∏è ${tituloTaxas}</h4>
                                <div style="margin-top:10px; padding:10px; background:white; border:1px solid #f5c6cb;">
                                    <div style="white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word; margin-top:5px; color:#333;">${textoTaxas}</div>
                                </div>
                             </div>`;
                }
            }
            html += `<div style="margin-top:20px; border:1px solid #ddd; padding:10px;">
                        <strong>PARECER:</strong><br>
                        <div style="white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word; margin-top:5px;">${parecer}</div>
                     </div>`;
            contentDiv.innerHTML = html;

            const fileInput = document.getElementById('uploadSparta');
            if (fileInput.files.length > 0) {
                imgDiv.innerHTML = '<h3>Anexos</h3>';
                for (let i = 0; i < fileInput.files.length; i++) {
                    const reader = new FileReader();
                    reader.onload = (e) => { const img = document.createElement('img'); img.src = e.target.result; imgDiv.appendChild(img); };
                    reader.readAsDataURL(fileInput.files[i]);
                }
            }

            setTimeout(() => {
                html2canvas(reportDiv, { scale: 1 }).then(canvas => {
                    const out = document.getElementById('imgOutputContainer'); out.innerHTML = '';
                    canvas.id = "finalCanvas"; canvas.style.maxWidth = "100%"; out.appendChild(canvas);
                    
                    if(isEmailMode) {
                        copiarImagem();
                    } else {
                        document.getElementById('resultadoModal').style.display = 'block';
                    }
                }).catch(e => alert("Erro ao renderizar imagem: " + e));
            }, 800);
        } catch(err) {
            alert("Erro fatal no script: " + err.message);
            console.error(err);
        }
    }

    function copiarImagem() {
        const canvas = document.getElementById('finalCanvas');
        if(!canvas) return;
        canvas.toBlob(blob => {
            try {
                const item = new ClipboardItem({ 'image/png': blob });
                navigator.clipboard.write([item]).then(() => {
                    alert('Imagem copiada! Cole no e-mail (Ctrl+V).');
                }).catch(err => {
                    console.error("Falha ao copiar:", err);
                    alert("Seu navegador bloqueou a c√≥pia direta. Por favor, clique com o bot√£o direito na imagem e selecione 'Copiar imagem' ou use o bot√£o 'Baixar Imagem'.");
                });
            } catch (e) {
                alert("Seu navegador n√£o suporta c√≥pia autom√°tica. Use o bot√£o direito do mouse ou o bot√£o 'Baixar Imagem'.");
            }
        });
    }

    function baixarImagem() {
        const canvas = document.getElementById('finalCanvas');
        if(!canvas) return;
        const link = document.createElement('a');
        link.download = 'PPI_Solicitacao.png';
        link.href = canvas.toDataURL();
        link.click();
    }

    const defaultSegments = ["AGRONEGOCIO", "ALIMENTACAO", "AUTOMOTIVOS E NAUTICO", "CALCADOS E ACESSORIOS", "ELETRONICOS", "ENTRETENIMENTO", "INSTITUICOES DE ENSINO", "JOALHERIA E BIJOUTERIAS", "MAGAZINES E LOJAS DEPARTAMENTOS", "MAQUINAS E PECAS", "MATERIAL CONSTRUCAO E ACABAMENTO", "MOVEIS E DECORACAO", "OTICA E RELOJOARIA", "PRODUTOS DIVERSOS", "SAUDE E ESTETICA", "SERVICOS DIVERSOS", "TURISMO", "VESTUARIO"];
    const defaultAlcadas = ["Selecione...", "Aprovado", "Al√ßada Regional", "Ger√™ncia Nacional de Neg√≥cios", "Diretor Nacional", "Vice - Presid√™ncia", "Presid√™ncia", "CAPI", "POC de Neg√≥cios", "Negado"];
    let currentSegments = [], currentAlcadas = [];

    window.onload = function() {
        carregarConfiguracoes();
        renderizarMenus();
        verificarFaturamento();
        verificarDataCNPJ();
        verificarPendencias();
        // INICIALIZA O VERIFICAR TAXAS
        verificarTaxas(); 
        document.querySelectorAll('input[onkeyup*="verificarGenerico"]').forEach(input => verificarGenerico(input));
    };

    function carregarConfiguracoes() {
        const storedSegs = localStorage.getItem('ppi_segmentos');
        const storedAlcs = localStorage.getItem('ppi_alcadas');
        currentSegments = storedSegs ? JSON.parse(storedSegs) : [...defaultSegments];
        currentAlcadas = storedAlcs ? JSON.parse(storedAlcs) : [...defaultAlcadas];
        const required = ["Aprovado", "CAPI", "Negado", "Al√ßada Regional", "Ger√™ncia Nacional de Neg√≥cios", "Vice - Presid√™ncia", "Presid√™ncia"];
        let mudou = false;
        required.forEach(req => { if(!currentAlcadas.includes(req)) { currentAlcadas.unshift(req); mudou = true; } });
        if(mudou) localStorage.setItem('ppi_alcadas', JSON.stringify(currentAlcadas));
    }
    function renderizarMenus() {
        const segSelect = document.getElementById('inputSegmento');
        segSelect.innerHTML = '<option value="">Selecione...</option>';
        currentSegments.forEach(seg => { let opt = document.createElement('option'); opt.value = seg; opt.text = seg; segSelect.appendChild(opt); });
        populateAlcadas();
    }
    function populateAlcadas() {
        document.querySelectorAll('.sel-alcada').forEach(select => {
            const valorAtual = select.value;
            select.innerHTML = ''; 
            currentAlcadas.forEach(alc => { let opt = document.createElement('option'); opt.value = alc; opt.text = alc; select.appendChild(opt); });
            if(currentAlcadas.includes(valorAtual)) { select.value = valorAtual; }
        });
    }
    function abrirConfig() { document.getElementById('cfgSegmentos').value = currentSegments.join('\n'); document.getElementById('cfgAlcadas').value = currentAlcadas.join('\n'); document.getElementById('configModal').style.display = 'flex'; }
    function fecharConfig() { document.getElementById('configModal').style.display = 'none'; }
    function salvarConfig() {
        const rawSegs = document.getElementById('cfgSegmentos').value.split('\n').map(s=>s.trim()).filter(s=>s!=="");
        const rawAlcs = document.getElementById('cfgAlcadas').value.split('\n').map(s=>s.trim()).filter(s=>s!=="");
        if(rawSegs.length===0 || rawAlcs.length===0) return alert("Listas vazias!");
        currentSegments = rawSegs; currentAlcadas = rawAlcs;
        localStorage.setItem('ppi_segmentos', JSON.stringify(currentSegments));
        localStorage.setItem('ppi_alcadas', JSON.stringify(currentAlcadas));
        renderizarMenus(); fecharConfig(); alert("Salvo!");
    }
    function resetarFabrica() { if(confirm("Resetar padr√µes?")) { localStorage.removeItem('ppi_segmentos'); localStorage.removeItem('ppi_alcadas'); location.reload(); } }
    function mudarSecaoPrincipal() { document.querySelectorAll('.section-content').forEach(el => el.style.display = 'none'); const tipo = document.getElementById('tipoSolicitacao').value; if(tipo) document.getElementById('section-' + tipo).style.display = 'block'; }
    function toggleAlcada() { const val = document.getElementById('selectForaAlcada').value; document.getElementById('boxAlcada').style.display = (val === 'SIM') ? 'block' : 'none'; }
    function novaSolicitacao() { if(confirm("Limpar tudo?")) location.reload(); }
</script>

</body>
</html>