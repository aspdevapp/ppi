<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPI - Portal de Processos Interno</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-color: #0056b3;
            --secondary-color: #f4f4f4;
            --border-color: #ddd;
            --text-color: #333;
            --success-color: #28a745;
            --dark-color: #343a40;
            --danger-color: #dc3545;
            --disabled-bg: #e9ecef;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #e9ecef;
            margin: 0;
            padding: 20px;
            color: var(--text-color);
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: relative;
        }

        /* --- BOT√ïES DO TOPO --- */
        .top-buttons {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        .btn-reset {
            background-color: var(--success-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            display: flex;
            align-items: center;
            transition: background 0.3s;
        }
        .btn-reset:hover { background-color: #218838; }

        .btn-config {
            background-color: var(--dark-color);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }
        .btn-config:hover { background-color: #23272b; }

        /* --- ESTILOS GERAIS --- */
        header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            padding-top: 20px;
        }

        h1 { color: var(--primary-color); margin: 0; }
        h2, h3 { color: #444; margin-top: 20px; }
        h4 { margin: 0 0 10px 0; color: var(--primary-color); }

        .form-group { margin-bottom: 15px; }

        label { display: block; margin-bottom: 5px; font-weight: 600; }

        input[type="text"], input[type="number"], input[type="date"], select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
        }

        input[type="file"] {
            background-color: white;
            padding: 10px;
        }

        select:disabled, input:disabled {
            background-color: var(--disabled-bg);
            color: #6c757d;
            cursor: not-allowed;
        }

        .section-content {
            display: none;
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: #fafafa;
            margin-top: 15px;
            animation: fadeIn 0.5s;
        }

        .alcada-container {
            display: none;
            margin-top: 20px;
            background: #fff;
            padding: 15px;
            border: 1px solid #ccc;
        }

        .alcada-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .alcada-table th, .alcada-table td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }
        .alcada-table th { background-color: var(--primary-color); color: white; }

        .sub-form-alert {
            display: none;
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            padding: 15px;
            margin-top: 10px;
            border-radius: 4px;
        }

        .restricao-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
            background-color: white;
        }
        .restricao-table th, .restricao-table td {
            border: 1px solid #e0c482;
            padding: 8px;
            text-align: left;
        }
        .restricao-table th { background-color: #ffecb5; color: #856404; }

        .btn-add-row {
            background-color: var(--success-color);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-remove-row {
            background-color: var(--danger-color);
            color: white;
            border: none;
            padding: 2px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 5px;
        }

        .flex-cell { display: flex; align-items: center; }

        /* --- BOT√ÉO GERAR --- */
        button.btn-generate {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            width: 100%;
            margin-top: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        button.btn-generate:hover { background-color: #004494; }

        /* --- √ÅREA DE RESULTADO (MODAL) --- */
        #resultadoModal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            overflow-y: auto;
            padding: 20px;
        }
        
        .resultado-content {
            background: #fff;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .btn-copy {
            background-color: #17a2b8;
            color: white;
            padding: 10px 25px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }
        .btn-close-res {
            background-color: #6c757d;
            color: white;
            padding: 10px 25px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }

        /* --- ESTILO DO RELAT√ìRIO OCULTO --- */
        #reportToImage {
            position: absolute;
            left: -9999px;
            top: 0;
            width: 800px;
            background: white;
            padding: 40px;
            font-family: Arial, sans-serif;
            border: 1px solid #ccc;
        }
        
        #reportToImage h2 { border-bottom: 2px solid #0056b3; color: #0056b3; padding-bottom: 10px; }
        .rep-row { margin-bottom: 10px; display: flex; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .rep-label { font-weight: bold; width: 250px; color: #555; }
        .rep-value { flex: 1; color: #000; font-weight: 500;}
        
        .rep-table { width: 100%; border-collapse: collapse; margin-top: 15px; margin-bottom: 15px; font-size: 14px;}
        .rep-table th, .rep-table td { border: 1px solid #999; padding: 6px; text-align: left; }
        .rep-table th { background-color: #0056b3; color: white; }

        .rep-images img { max-width: 100%; margin-top: 10px; border: 1px solid #ccc; padding: 5px; display: block;}

        /* MODAL DE CONFIGURA√á√ÉO */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 8px; width: 500px; max-width: 90%; }
        .modal-footer { display: flex; justify-content: space-between; margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px; }
        textarea.config-area { width: 100%; height: 120px; font-family: monospace; font-size: 12px; margin-bottom: 15px; resize: vertical; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    <div class="top-buttons">
        <button class="btn-config" onclick="abrirConfig()" title="Configura√ß√µes">‚öôÔ∏è</button>
        <button class="btn-reset" onclick="novaSolicitacao()" title="Limpar formul√°rio">‚Üª NOVA SOLICITA√á√ÉO</button>
    </div>

    <header>
        <h1>PPI - Portal de Processos Interno</h1>
        <p>Centraliza√ß√£o de Vendas, P√≥s-Vendas e Administrativo</p>
    </header>

    <div class="form-group">
        <label for="tipoSolicitacao">Tipo de Solicita√ß√£o:</label>
        <select id="tipoSolicitacao" onchange="mudarSecaoPrincipal()">
            <option value="">-- Selecione --</option>
            <option value="VENDAS">VENDAS</option>
            <option value="POS_VENDAS">P√ìS VENDAS</option>
            <option value="ADMINISTRATIVO">ADMINISTRATIVO</option>
        </select>
    </div>

    <div id="section-VENDAS" class="section-content">
        <h2>Solicita√ß√£o de Vendas</h2>
        
        <div class="form-group">
            <label>Sub-tipo de Venda:</label>
            <select id="subTipoVenda">
                <option value="CAPI">CAPI DE VENDAS</option>
                <option value="POC">POC DE VENDAS</option>
            </select>
        </div>

        <h3>Dados do Cliente</h3>
        <div class="form-group">
            <label>Raz√£o Social:</label>
            <input type="text" id="inpRazao" placeholder="Digite a Raz√£o Social" oninput="this.value = this.value.toUpperCase()">
        </div>
        
        <div class="form-group">
            <label>Nome do Lead (Sparta):</label>
            <input type="text" id="inpLead" placeholder="Nome igual do SPARTA" oninput="this.value = this.value.toUpperCase()">
        </div>

        <div class="form-group">
            <label>Quantidade de Lojas:</label>
            <input type="number" id="inpLojas" placeholder="0">
        </div>

        <div class="form-group">
            <label>Segmento:</label>
            <select id="inputSegmento">
                <option value="">Carregando...</option>
            </select>
        </div>

        <div class="form-group">
            <label>Produto:</label>
            <select id="inpProduto">
                <option value="MultiCheck">MultiCheck</option>
                <option value="MultiCredi√°rio">MultiCredi√°rio</option>
                <option value="PayCheck">PayCheck</option>
            </select>
        </div>

        <hr>

        <div class="form-group">
            <label>H√° condi√ß√£o fora da al√ßada do regional?</label>
            <select id="selectForaAlcada" onchange="toggleAlcada()">
                <option value="NAO">N√ÉO</option>
                <option value="SIM">SIM</option>
            </select>
        </div>

        <div id="boxAlcada" class="alcada-container">
            <h3>Tabela de Condi√ß√µes Especiais</h3>
            <table class="alcada-table" id="tabelaCondicoesBase">
                <thead>
                    <tr>
                        <th style="width: 40%;">ITEM</th>
                        <th style="width: 30%;">VALOR / DADO</th>
                        <th style="width: 30%;">AL√áADA</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Faturamento Presumido</td>
                        <td><input type="text" placeholder="R$"></td>
                        <td><select class="sel-alcada"></select></td>
                    </tr>
                    <tr>
                        <td>Data de Abertura CNPJ</td>
                        <td>
                            <input type="date" id="inputDataAbertura" onchange="verificarDataCNPJ()">
                        </td>
                        <td>
                            <select class="sel-alcada" id="selAlcadaData"></select>
                        </td>
                    </tr>
                    <tr>
                        <td>Pend√™ncias Financeiras (R$)</td>
                        <td><input type="number" id="inputPendencias" placeholder="0.00" onkeyup="verificarPendencias()"></td>
                        <td><select class="sel-alcada"></select></td>
                    </tr>
                </tbody>
            </table>
            
            <div id="formPendenciasDetalhe" class="sub-form-alert">
                <h4>Resumo das Restri√ß√µes (> R$ 7.000,00)</h4>
                <table class="restricao-table" id="tabelaRestricoes">
                    <thead>
                        <tr>
                            <th style="width: 40%;">Fornecedor</th>
                            <th style="width: 30%;">Tipo de Restri√ß√£o</th>
                            <th style="width: 20%;">Valor (R$)</th>
                            <th style="width: 10%;">A√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <button type="button" class="btn-add-row" onclick="adicionarLinhaRestricao()">+ Adicionar Linha</button>
            </div>

            <table class="alcada-table" style="margin-top:0; border-top:none;">
                <tbody id="tbodyAlcadaExtras">
                    <tr>
                        <td style="width: 40%;">Taxas (IP)</td>
                        <td style="width: 30%;"><input type="text"></td>
                        <td style="width: 30%;"><select class="sel-alcada"></select></td>
                    </tr>
                    <tr>
                        <td>Taxas (Flat/A.M)</td>
                        <td><input type="text"></td>
                        <td><select class="sel-alcada"></select></td>
                    </tr>
                    <tr>
                        <td>Prazo de Acatamento</td>
                        <td><input type="text"></td>
                        <td><select class="sel-alcada"></select></td>
                    </tr>
                    <tr>
                        <td>TAP/TGO</td>
                        <td><input type="text"></td>
                        <td><select class="sel-alcada"></select></td>
                    </tr>
                    <tr>
                        <td><input type="text" placeholder="Outro Item (Digite o nome)"></td>
                        <td><input type="text"></td>
                        <td><select class="sel-alcada"></select></td>
                    </tr>
                </tbody>
            </table>
            
            <div style="text-align: right; margin-top: 10px;">
                <button type="button" class="btn-add-row" onclick="adicionarLinhaAlcada()">+ Adicionar Item Personalizado</button>
            </div>
        </div>

        <div class="form-group" style="margin-top: 20px;">
            <label for="observacoesVendas">Parecer de Vendas:</label>
            <textarea id="observacoesVendas" rows="4" placeholder="Digite aqui o parecer de vendas..."></textarea>
        </div>

        <div class="form-group" style="margin-top: 15px;">
            <label for="uploadSparta">PESQUISA PROFUNDA (SPARTA):</label>
            <input type="file" id="uploadSparta" accept="image/*" multiple>
            <p style="font-size: 12px; color: #666; margin-top: 5px;">Selecione as imagens ou prints da pesquisa (Permite m√∫ltiplos arquivos).</p>
        </div>

        <button class="btn-generate" onclick="gerarImagemResumo()">üì∏ GERAR SOLICITA√á√ÉO DE VENDAS</button>
    </div>

    <div id="section-POS_VENDAS" class="section-content">
        <h2>P√≥s Vendas</h2>
        <button class="btn-generate">Gerar Solicita√ß√£o</button>
    </div>
    <div id="section-ADMINISTRATIVO" class="section-content">
        <h2>Administrativo</h2>
        <button class="btn-generate">Gerar Solicita√ß√£o</button>
    </div>
</div>

<div id="reportToImage">
    <h2 style="text-align:center;">SOLICITA√á√ÉO DE VENDAS - PPI</h2>
    <div id="reportContent"></div>
    <div id="reportImages" class="rep-images"></div>
</div>

<div id="resultadoModal">
    <div class="resultado-content">
        <h3 style="color: var(--primary-color);">Solicita√ß√£o Gerada com Sucesso!</h3>
        <p>Abaixo est√° a imagem gerada. Clique em "Copiar Imagem" para colar no e-mail.</p>
        <div id="imgOutputContainer" style="border: 1px solid #ccc; padding: 5px; margin-bottom: 10px; overflow-x: auto;"></div>
        <button class="btn-copy" onclick="copiarImagem()">üìã Copiar Imagem</button>
        <button class="btn-close-res" onclick="document.getElementById('resultadoModal').style.display='none'">Fechar</button>
    </div>
</div>

<div id="configModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header"><h3>Configura√ß√µes</h3><span style="cursor:pointer; font-size:20px;" onclick="fecharConfig()">√ó</span></div>
        <label>Segmentos:</label><textarea id="cfgSegmentos" class="config-area"></textarea>
        <label>Al√ßadas:</label><textarea id="cfgAlcadas" class="config-area"></textarea>
        <div class="modal-footer">
            <button class="btn-reset-factory" onclick="resetarFabrica()">Restaurar Padr√µes</button>
            <div><button onclick="fecharConfig()" style="margin-right:5px; padding:5px;">Cancelar</button><button onclick="salvarConfig()" style="padding:5px;">Salvar</button></div>
        </div>
    </div>
</div>

<script>
    async function gerarImagemResumo() {
        // --- VALIDA√á√ÉO DE SOMA DAS RESTRI√á√ïES (NOVO) ---
        const totalPendencias = parseFloat(document.getElementById('inputPendencias').value) || 0;
        
        // S√≥ valida se o valor for maior que 7000 (quando a tabela aparece)
        if (totalPendencias > 7000) {
            let somaRestricoes = 0;
            const rows = document.querySelectorAll('#tabelaRestricoes tbody tr');
            
            rows.forEach(row => {
                const inputs = row.querySelectorAll('input');
                // O valor √© o terceiro input (index 2)
                const val = parseFloat(inputs[2].value) || 0;
                somaRestricoes += val;
            });

            // Arredonda para 2 casas decimais para evitar erro de ponto flutuante
            const diff = Math.abs(totalPendencias - somaRestricoes);
            
            if (diff > 0.01) {
                alert(`ERRO DE VALIDA√á√ÉO:\n\nO valor total de Pend√™ncias Financeiras informado (R$ ${totalPendencias.toFixed(2)}) N√ÉO bate com a soma das linhas de restri√ß√µes (R$ ${somaRestricoes.toFixed(2)}).\n\nPor favor, corrija os valores antes de gerar a solicita√ß√£o.`);
                return; // Para a execu√ß√£o
            }
        }
        // -----------------------------------------------

        const reportDiv = document.getElementById('reportToImage');
        const contentDiv = document.getElementById('reportContent');
        const imgDiv = document.getElementById('reportImages');
        
        contentDiv.innerHTML = '';
        imgDiv.innerHTML = '';

        const subtipo = document.getElementById('subTipoVenda').value;
        const razao = document.getElementById('inpRazao').value || '-';
        const lead = document.getElementById('inpLead').value || '-';
        const lojas = document.getElementById('inpLojas').value || '-';
        const segmento = document.getElementById('inputSegmento').value || '-';
        const produto = document.getElementById('inpProduto').value || '-';
        const foraAlcada = document.getElementById('selectForaAlcada').value;
        const parecer = document.getElementById('observacoesVendas').value || 'Nenhum parecer informado.';

        let html = `
            <div class="rep-row"><span class="rep-label">Tipo de Solicita√ß√£o:</span> <span class="rep-value">VENDAS (${subtipo})</span></div>
            <div class="rep-row"><span class="rep-label">Raz√£o Social:</span> <span class="rep-value">${razao}</span></div>
            <div class="rep-row"><span class="rep-label">Lead (Sparta):</span> <span class="rep-value">${lead}</span></div>
            <div class="rep-row"><span class="rep-label">Qtd. Lojas:</span> <span class="rep-value">${lojas}</span></div>
            <div class="rep-row"><span class="rep-label">Segmento:</span> <span class="rep-value">${segmento}</span></div>
            <div class="rep-row"><span class="rep-label">Produto:</span> <span class="rep-value">${produto}</span></div>
            <div class="rep-row"><span class="rep-label">Fora da Al√ßada Regional?</span> <span class="rep-value">${foraAlcada}</span></div>
        `;

        if(foraAlcada === 'SIM') {
            html += `<h3>Condi√ß√µes Especiais & Al√ßadas</h3>
                     <table class="rep-table">
                        <thead><tr><th>Item</th><th>Valor/Dado</th><th>Al√ßada</th></tr></thead>
                        <tbody>`;
            
            const rowsBase = document.querySelectorAll('#tabelaCondicoesBase tbody tr');
            rowsBase.forEach(tr => {
                const tds = tr.querySelectorAll('td');
                const item = tds[0].innerText.trim();
                let val = tds[1].querySelector('input') ? tds[1].querySelector('input').value : '';
                let alc = tds[2].querySelector('select') ? tds[2].querySelector('select').value : '';
                html += `<tr><td>${item}</td><td>${val}</td><td>${alc}</td></tr>`;
            });

            const rowsExtra = document.querySelectorAll('#tbodyAlcadaExtras tr');
            rowsExtra.forEach(tr => {
                const tds = tr.querySelectorAll('td');
                let item = tds[0].querySelector('input') ? tds[0].querySelector('input').value : (tds[0].innerText.trim());
                let val = tds[1].querySelector('input') ? tds[1].querySelector('input').value : '';
                let alc = tds[2].querySelector('select') ? tds[2].querySelector('select').value : '';
                if(item) html += `<tr><td>${item}</td><td>${val}</td><td>${alc}</td></tr>`;
            });

            html += `</tbody></table>`;

            const rowsRestr = document.querySelectorAll('#tabelaRestricoes tbody tr');
            if(rowsRestr.length > 0) {
                 html += `<h4>Detalhamento de Restri√ß√µes (> R$ 7k)</h4>
                          <table class="rep-table" style="border-color:#e0c482">
                            <thead><tr style="background:#ffecb5; color:#856404"><th>Fornecedor</th><th>Restri√ß√£o</th><th>Valor</th></tr></thead>
                            <tbody>`;
                 rowsRestr.forEach(tr => {
                    const inputs = tr.querySelectorAll('input');
                    html += `<tr><td>${inputs[0].value}</td><td>${inputs[1].value}</td><td>R$ ${inputs[2].value}</td></tr>`;
                 });
                 html += `</tbody></table>`;
            }
        }

        html += `<div style="margin-top:20px; border:1px solid #ddd; padding:10px; background:#f9f9f9;">
                    <strong>PARECER DE VENDAS:</strong><br>
                    <p style="white-space: pre-wrap;">${parecer}</p>
                 </div>`;

        contentDiv.innerHTML = html;

        const fileInput = document.getElementById('uploadSparta');
        if (fileInput.files && fileInput.files.length > 0) {
            imgDiv.innerHTML = '<h3>Anexos (Pesquisa Profunda SPARTA)</h3>';
            const readFile = (file) => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(file);
                });
            };
            for (let i = 0; i < fileInput.files.length; i++) {
                const base64 = await readFile(fileInput.files[i]);
                const imgTag = document.createElement('img');
                imgTag.src = base64;
                imgDiv.appendChild(imgTag);
            }
        }

        setTimeout(() => {
            html2canvas(reportDiv, { scale: 1 }).then(canvas => {
                const outContainer = document.getElementById('imgOutputContainer');
                outContainer.innerHTML = '';
                canvas.id = "finalCanvas";
                canvas.style.maxWidth = "100%";
                canvas.style.height = "auto";
                outContainer.appendChild(canvas);
                document.getElementById('resultadoModal').style.display = 'block';
            });
        }, 500);
    }

    function copiarImagem() {
        const canvas = document.getElementById('finalCanvas');
        if(!canvas) return;
        canvas.toBlob(blob => {
            try {
                const item = new ClipboardItem({ 'image/png': blob });
                navigator.clipboard.write([item]).then(() => {
                    alert('Imagem copiada para a √°rea de transfer√™ncia! Agora basta colar no e-mail (Ctrl+V).');
                }).catch(err => { alert('Erro ao copiar. Use o bot√£o direito do mouse na imagem.'); });
            } catch (e) { alert('Seu navegador n√£o suporta c√≥pia autom√°tica.'); }
        });
    }

    // --- CONFIGURA√á√ïES E DEMAIS FUN√á√ïES ---
    const defaultSegments = ["AGRONEGOCIO", "ALIMENTACAO", "AUTOMOTIVOS E NAUTICO", "CALCADOS E ACESSORIOS", "ELETRONICOS", "ENTRETENIMENTO", "INSTITUICOES DE ENSINO", "JOALHERIA E BIJOUTERIAS", "MAGAZINES E LOJAS DEPARTAMENTOS", "MAQUINAS E PECAS", "MATERIAL CONSTRUCAO E ACABAMENTO", "MOVEIS E DECORACAO", "OTICA E RELOJOARIA", "PRODUTOS DIVERSOS", "SAUDE E ESTETICA", "SERVICOS DIVERSOS", "TURISMO", "VESTUARIO"];
    const defaultAlcadas = ["Selecione...", "Al√ßada Regional", "Ger√™ncia Nacional de Neg√≥cios", "Diretor Nacional", "CAPI", "POC de Neg√≥cios", "Negado"];
    let currentSegments = [], currentAlcadas = [];

    window.onload = function() { carregarConfiguracoes(); renderizarMenus(); };

    function carregarConfiguracoes() {
        const storedSegs = localStorage.getItem('ppi_segmentos');
        const storedAlcs = localStorage.getItem('ppi_alcadas');
        currentSegments = storedSegs ? JSON.parse(storedSegs) : [...defaultSegments];
        currentAlcadas = storedAlcs ? JSON.parse(storedAlcs) : [...defaultAlcadas];
    }
    function renderizarMenus() {
        const segSelect = document.getElementById('inputSegmento');
        segSelect.innerHTML = '<option value="">Selecione...</option>';
        currentSegments.forEach(seg => { let opt = document.createElement('option'); opt.value = seg; opt.text = seg; segSelect.appendChild(opt); });
        populateAlcadas();
    }
    function populateAlcadas() {
        document.querySelectorAll('.sel-alcada').forEach(select => {
            const valorAtual = select.value;
            select.innerHTML = ''; 
            currentAlcadas.forEach(alc => { let opt = document.createElement('option'); opt.value = alc; opt.text = alc; select.appendChild(opt); });
            if(currentAlcadas.includes(valorAtual)) select.value = valorAtual;
        });
    }
    function abrirConfig() { document.getElementById('cfgSegmentos').value = currentSegments.join('\n'); document.getElementById('cfgAlcadas').value = currentAlcadas.join('\n'); document.getElementById('configModal').style.display = 'flex'; }
    function fecharConfig() { document.getElementById('configModal').style.display = 'none'; }
    function salvarConfig() {
        const rawSegs = document.getElementById('cfgSegmentos').value.split('\n').map(s=>s.trim()).filter(s=>s!=="");
        const rawAlcs = document.getElementById('cfgAlcadas').value.split('\n').map(s=>s.trim()).filter(s=>s!=="");
        if(rawSegs.length===0 || rawAlcs.length===0) return alert("Listas vazias!");
        currentSegments = rawSegs; currentAlcadas = rawAlcs;
        localStorage.setItem('ppi_segmentos', JSON.stringify(currentSegments));
        localStorage.setItem('ppi_alcadas', JSON.stringify(currentAlcadas));
        renderizarMenus(); fecharConfig(); alert("Salvo!");
    }
    function resetarFabrica() { if(confirm("Resetar padr√µes?")) { localStorage.removeItem('ppi_segmentos'); localStorage.removeItem('ppi_alcadas'); location.reload(); } }

    function mudarSecaoPrincipal() {
        document.querySelectorAll('.section-content').forEach(el => el.style.display = 'none');
        const tipo = document.getElementById('tipoSolicitacao').value;
        if(tipo) document.getElementById('section-' + tipo).style.display = 'block';
    }
    function toggleAlcada() {
        const val = document.getElementById('selectForaAlcada').value;
        document.getElementById('boxAlcada').style.display = (val === 'SIM') ? 'block' : 'none';
    }
    function verificarPendencias() {
        const inputVal = document.getElementById('inputPendencias').value;
        const detalheDiv = document.getElementById('formPendenciasDetalhe');
        const tbody = document.querySelector('#tabelaRestricoes tbody');
        if (inputVal > 7000) { detalheDiv.style.display = 'block'; if(tbody.rows.length===0) adicionarLinhaRestricao(); } else { detalheDiv.style.display = 'none'; }
    }
    function adicionarLinhaRestricao() {
        const tbody = document.querySelector('#tabelaRestricoes tbody');
        const row = document.createElement('tr');
        row.innerHTML = `<td><input type="text" placeholder="Fornecedor"></td><td><input type="text" placeholder="Tipo"></td><td><input type="number" placeholder="Valor"></td><td style="text-align:center;"><button type="button" class="btn-remove-row" onclick="this.parentNode.parentNode.remove()">X</button></td>`;
        tbody.appendChild(row);
    }
    function verificarDataCNPJ() {
        const inputDateVal = document.getElementById('inputDataAbertura').value;
        const selectAlcada = document.getElementById('selAlcadaData');
        if (!inputDateVal) { selectAlcada.disabled = false; selectAlcada.value = ""; return; }
        const dataAbertura = new Date(inputDateVal);
        const dataLimite = new Date(); dataLimite.setFullYear(dataLimite.getFullYear() - 1);
        if (dataAbertura < dataLimite) { selectAlcada.value = ""; selectAlcada.disabled = true; } else { selectAlcada.disabled = false; selectAlcada.value = "CAPI"; }
    }
    function adicionarLinhaAlcada() {
        const tbody = document.getElementById('tbodyAlcadaExtras');
        const row = document.createElement('tr');
        const td1 = document.createElement('td'); td1.innerHTML = '<input type="text" placeholder="Item">';
        const td2 = document.createElement('td'); td2.innerHTML = '<input type="text" placeholder="Valor">';
        const td3 = document.createElement('td'); td3.className = 'flex-cell';
        const select = document.createElement('select'); select.className = 'sel-alcada';
        currentAlcadas.forEach(alc => { let opt = document.createElement('option'); opt.value = alc; opt.text = alc; select.appendChild(opt); });
        const btnDel = document.createElement('button'); btnDel.type = 'button'; btnDel.textContent = 'X'; btnDel.className = 'btn-remove-row'; btnDel.onclick = function() { tbody.removeChild(row); };
        td3.appendChild(select); td3.appendChild(btnDel);
        row.appendChild(td1); row.appendChild(td2); row.appendChild(td3); tbody.appendChild(row);
    }
    function novaSolicitacao() { if(confirm("Limpar tudo?")) location.reload(); }
</script>

</body>
</html>